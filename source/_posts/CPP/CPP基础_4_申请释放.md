---
title: 【CPP基础】【四】【申请释放】
tags: cpp
categories: cpp
abbrlink: 43547
date: 2024-11-24 21:30:36
---

在C++中，`new`和`delete`是用于动态内存分配和释放的运算符。它们与堆内存相关，允许程序在运行时分配和管理内存。

# new 运算符

`new`运算符用于在堆上分配内存。它可以用于分配单个对象或对象数组，并返回指向所分配内存的指针。

## 用法

1. **分配单个对象：**
   ```cpp
   MyClass* obj = new MyClass();
   ```
   这行代码在堆上分配一个`MyClass`对象，并调用其构造函数。返回值是指向这个对象的指针。

2. **分配数组：**
   ```cpp
   int* arr = new int[10];
   ```
   这里在堆上分配了一个包含10个整数的数组，返回指向数组首元素的指针。

3. **初始化：**
   `new`还可以用来初始化对象：
   ```cpp
   int* num = new int(5); // 分配内存并将其初始化为5
   ```

# delete 运算符

`delete`运算符用于释放之前使用`new`分配的内存。它可以释放单个对象或对象数组。

## 用法

1. **释放单个对象：**
   ```cpp
   delete obj;
   ```
   这行代码会调用`obj`指向的对象的析构函数，并释放该对象占用的内存。

2. **释放数组：**
   ```cpp
   delete[] arr;
   ```
   这里使用`delete[]`来释放使用`new[]`分配的数组。需要注意，使用`delete[]`和`delete`不可以互换。

## 悬挂指针

在释放内存后，将指针设置为`nullptr`是一个良好的编程习惯。这可以防止悬挂指针问题，即指针仍然指向已经被释放的内存区域。

```cpp
obj = nullptr;
```

## 注意事项

1. **配对使用：** 每个由`new`分配的内存都应该用`delete`释放，每个`new[]`分配的数组都应该用`delete[]`释放，以避免内存泄漏。

2. **避免重复释放：** 在释放指针后，应该清楚指针的状态，避免重复释放同一内存区域。

3. **自定义析构函数：** 如果类中有动态内存分配的成员，确保在类的析构函数中适当释放这些资源，避免内存泄漏。

通过正确使用`new`和`delete`，可以有效地管理C++程序中的动态内存。
详细demo代码如下
```cpp
#include <iostream>

class MyClass 
{
public:
    MyClass() { /* 构造函数代码 */ }
    // 如果需要，可以添加析构函数、其他成员函数和数据成员
};

int main()
{
    int* ptr = new int;        // 为一个整数分配内存
    int* arr = new int[10];    // 为一个整数数组分配内存

    MyClass* obj = new MyClass();  // 调用构造函数

    *ptr = 12;
    delete ptr;    // 释放单个对象 这边释放后ptr指向的内存区域将被释放，,详细debug看ptr指向的值以及变成其他值

    delete[] arr;  // 释放数组
    ptr = nullptr; // 防止悬挂指针

    // 如果MyClass有自定义的析构函数，也应该在此处释放obj
    delete obj;
    obj = nullptr; // 防止悬挂指针

    return 0;
}
```
